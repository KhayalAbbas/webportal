{% extends "base.html" %}
{% block title %}Research Workspace{% endblock %}
{% block content %}
<h1 class="page-title">Research Workspace</h1>
{% if success_message %}
<div class="alert alert-success">{{ success_message }}</div>
{% endif %}
{% if error_message %}
<div class="alert alert-error">{{ error_message }}</div>
{% endif %}
<div class="card" style="padding:15px;margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:20px;">
        <div>
            <div class="section-title" style="margin-top:0;">{{ run.name }}</div>
            <div class="text-muted">Industry: {{ run.sector or '-' }} | Region: {% if run.region_scope %}{{ ', '.join(run.region_scope) }}{% else %}-{% endif %}</div>
            {% if run.description %}<div class="text-muted">{{ run.description }}</div>{% endif %}
        </div>
        <div style="text-align:right;">
            <span class="badge {% if run.status in ['queued','running','active'] %}badge-info{% elif run.status in ['completed','succeeded'] %}badge-success{% elif run.status in ['failed','cancelled'] %}badge-danger{% else %}badge-warning{% endif %}">{{ run.status }}</span>
            <div style="margin-top:8px;">
                <form method="post" action="/ui/research/runs/{{ run.id }}/executive-discovery">
                    <button type="submit" class="btn" {% if eligible_exec_companies == 0 %}disabled{% endif %}>Find executives</button>
                </form>
                {% if eligible_exec_companies == 0 %}
                <div class="text-muted" style="font-size:11px;">Enable exec search by accepting a company.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="section-title">Companies</div>
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Location</th>
            <th>Sector</th>
            <th>Score</th>
            <th>Review</th>
            <th>Evidence</th>
            <th>Rank</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% if prospects %}
            {% for p in prospects %}
            <tr>
                <td>{{ p.name }}</td>
                <td>{{ p.hq_city or '-' }}, {{ p.hq_country or '-' }}</td>
                <td>{{ p.sector or '-' }}</td>
                <td>{{ '%.2f'|format(p.relevance_score or 0) }}</td>
                <td>
                    <span class="badge {% if p.review_status == 'accepted' %}badge-success{% elif p.review_status == 'hold' %}badge-warning{% elif p.review_status == 'rejected' %}badge-danger{% else %}badge-info{% endif %}">{{ p.review_status }}</span>
                </td>
                <td>
                    {% if p.primary_evidence_url %}
                        <a href="{{ p.primary_evidence_url }}" target="_blank">source</a>
                    {% else %}-{% endif %}
                </td>
                <td>
                    <form method="post" action="/ui/research/prospects/{{ p.id }}/rank" style="display:inline-block;">
                        <input type="hidden" name="run_id" value="{{ run.id }}" />
                        <input type="hidden" name="direction" value="up" />
                        <button type="submit" class="btn btn-secondary" style="padding:4px 8px;">↑</button>
                    </form>
                    <form method="post" action="/ui/research/prospects/{{ p.id }}/rank" style="display:inline-block;">
                        <input type="hidden" name="run_id" value="{{ run.id }}" />
                        <input type="hidden" name="direction" value="down" />
                        <button type="submit" class="btn btn-secondary" style="padding:4px 8px;">↓</button>
                    </form>
                </td>
                <td>
                    <form method="post" action="/ui/research/prospects/{{ p.id }}/review" style="display:inline-block;">
                        <input type="hidden" name="run_id" value="{{ run.id }}" />
                        <input type="hidden" name="review_status" value="accepted" />
                        <input type="hidden" name="enable_exec_search" value="true" />
                        <button type="submit" class="btn" style="padding:6px 10px;">Accept</button>
                    </form>
                    <form method="post" action="/ui/research/prospects/{{ p.id }}/review" style="display:inline-block;">
                        <input type="hidden" name="run_id" value="{{ run.id }}" />
                        <input type="hidden" name="review_status" value="hold" />
                        <button type="submit" class="btn btn-secondary" style="padding:6px 10px;">Hold</button>
                    </form>
                    <form method="post" action="/ui/research/prospects/{{ p.id }}/review" style="display:inline-block;">
                        <input type="hidden" name="run_id" value="{{ run.id }}" />
                        <input type="hidden" name="review_status" value="rejected" />
                        <button type="submit" class="btn btn-secondary" style="padding:6px 10px;">Reject</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr><td colspan="8" class="text-center text-muted">No prospects yet.</td></tr>
        {% endif %}
    </tbody>
</table>

<div class="section-title">Executives</div>
{% if has_execs %}
<form method="post" action="/ui/research/executives/pipeline">
    <input type="hidden" name="run_id" value="{{ run.id }}" />
    <table>
        <thead>
            <tr>
                <th>Select</th>
                <th>Name</th>
                <th>Title</th>
                <th>Company</th>
                <th>Evidence</th>
            </tr>
        </thead>
        <tbody>
            {% for exec in executives %}
            <tr>
                <td><input type="checkbox" name="executive_ids" value="{{ exec.id }}" /></td>
                <td>{{ exec.name or '-' }}</td>
                <td>{{ exec.title or '-' }}</td>
                <td>{{ exec.company or '-' }}</td>
                <td>{% if exec.evidence_url %}<a href="{{ exec.evidence_url }}" target="_blank">link</a>{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="display:flex;align-items:center;gap:10px;margin-top:10px;">
        <label for="stage_id">Stage</label>
        <select id="stage_id" name="stage_id" style="width:200px;">
            <option value="">Default</option>
            {% for stage in pipeline_stages %}
            <option value="{{ stage.id }}">{{ stage.name }} ({{ stage.code }})</option>
            {% endfor %}
        </select>
        <label for="assignment_status">Status</label>
        <select id="assignment_status" name="assignment_status" style="width:180px;">
            <option value="">Default</option>
            <option value="active">Active</option>
            <option value="prospect">Prospect</option>
            <option value="submitted">Submitted</option>
        </select>
        <button type="submit" class="btn">Add selected to Search</button>
    </div>
</form>
{% else %}
<div class="text-muted">Run executive discovery to see results.</div>
{% endif %}
{% endblock %}
