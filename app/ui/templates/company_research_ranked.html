{% extends "base.html" %}

{% block title %}Ranked Prospects - Company Research - The Phillips Group{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h1 class="page-title" style="margin: 0;">Ranked Prospects</h1>
    <div>
        <a href="/ui/company-research/runs/{{ run.id }}" class="btn btn-secondary">← Back to Run</a>
    </div>
</div>

<div style="margin-bottom: 12px; font-size: 13px; color: #444;">
    <strong>Run:</strong> {{ run.name }} {% if role_info %}· <strong>Role:</strong> {{ role_info.title }} ({{ role_info.company_name }}){% endif %}
</div>

<form method="get" style="display: flex; gap: 12px; align-items: flex-end; margin-bottom: 16px; font-size: 13px;">
    <div>
        <label for="min_score" style="font-weight: 600;">Min score</label><br>
        <input type="number" step="0.01" name="min_score" id="min_score" value="{{ filters.min_score if filters.min_score is not none else '' }}" style="width: 120px; padding: 6px;">
    </div>
    <div>
        <label style="font-weight: 600;">Signals</label><br>
        <label style="margin-right: 10px;"><input type="checkbox" name="has_hq" value="true" {% if filters.has_hq %}checked{% endif %}> HQ country</label>
        <label style="margin-right: 10px;"><input type="checkbox" name="has_ownership" value="true" {% if filters.has_ownership %}checked{% endif %}> Ownership</label>
        <label><input type="checkbox" name="has_industry" value="true" {% if filters.has_industry %}checked{% endif %}> Industry keywords</label>
    </div>
    <div>
        <label for="review_status" style="font-weight: 600;">Review status</label><br>
        <select name="review_status" id="review_status" style="padding: 6px; min-width: 140px;">
            <option value="">Any</option>
            {% for opt in ['new','accepted','hold','rejected'] %}
            <option value="{{ opt }}" {% if filters.review_status == opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label for="verification_status" style="font-weight: 600;">Verification</label><br>
        <select name="verification_status" id="verification_status" style="padding: 6px; min-width: 140px;">
            <option value="">Any</option>
            {% for opt in ['unverified','partial','verified'] %}
            <option value="{{ opt }}" {% if filters.verification_status == opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label for="discovered_by" style="font-weight: 600;">Discovered by</label><br>
        <select name="discovered_by" id="discovered_by" style="padding: 6px; min-width: 150px;">
            <option value="">Any</option>
            {% for opt in ['internal','grok','external_llm','both','manual'] %}
            <option value="{{ opt }}" {% if filters.discovered_by == opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label for="exec_search_enabled" style="font-weight: 600;">Exec search</label><br>
        <select name="exec_search_enabled" id="exec_search_enabled" style="padding: 6px; min-width: 120px;">
            <option value="">Any</option>
            <option value="true" {% if filters.exec_search_enabled is sameas true %}selected{% endif %}>Enabled</option>
            <option value="false" {% if filters.exec_search_enabled is sameas false %}selected{% endif %}>Disabled</option>
        </select>
    </div>
    <div>
        <button type="submit" class="btn btn-primary">Apply Filters</button>
        <a href="/ui/company-research/runs/{{ run.id }}/prospects-ranked" class="btn btn-secondary" style="margin-left: 6px;">Reset</a>
    </div>
</form>

<div style="margin-bottom: 10px; font-size: 13px; color: #555;">Showing {{ total_count }} ranked prospects.</div>

{% if prospects %}
<table style="width: 100%; border-collapse: collapse; font-size: 13px;">
    <thead>
        <tr style="background: #f8f9fa;">
            <th style="text-align: left; padding: 8px; width: 60px;">Rank</th>
            <th style="text-align: left; padding: 8px;">Company</th>
            <th style="text-align: left; padding: 8px; width: 90px;">Score</th>
            <th style="text-align: left; padding: 8px; width: 120px;">Review</th>
            <th style="text-align: left; padding: 8px; width: 130px;">Verification</th>
            <th style="text-align: left; padding: 8px; width: 140px;">Discovered by</th>
            <th style="text-align: left; padding: 8px; width: 120px;">Exec search</th>
            <th style="text-align: left; padding: 8px; width: 100px;">HQ Country</th>
            <th style="text-align: left; padding: 8px; width: 140px;">Ownership</th>
            <th style="text-align: left; padding: 8px; width: 220px;">Industry Keywords</th>
            <th style="text-align: left; padding: 8px; width: 110px;">Evidence Count</th>
            <th style="text-align: left; padding: 8px;">Why included</th>
            <th style="text-align: left; padding: 8px; width: 200px;">Review actions</th>
        </tr>
    </thead>
    <tbody>
        {% for prospect in prospects %}
        {% set ownership = '' %}
        {% set industry = '' %}
        {% for sig in prospect.why_included %}
            {% if sig.field_key == 'ownership_signal' %}{% set ownership = sig.value_normalized or sig.value %}{% endif %}
            {% if sig.field_key == 'industry_keywords' %}
                {% if sig.value is sequence and (sig.value is not string) %}
                    {% set industry = sig.value | join('; ') %}
                {% else %}
                    {% set industry = sig.value %}
                {% endif %}
            {% endif %}
        {% endfor %}
        <tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 8px; font-weight: 600;">{{ loop.index }}</td>
            <td style="padding: 8px; font-weight: 600;">{{ prospect.name_normalized }}</td>
            <td style="padding: 8px;">{{ '%.3f'|format(prospect.computed_score) }}</td>
            <td style="padding: 8px;">{{ prospect.review_status }}</td>
            <td style="padding: 8px;">{{ prospect.verification_status }}</td>
            <td style="padding: 8px;">{{ prospect.discovered_by }}</td>
            <td style="padding: 8px;">{{ prospect.exec_search_enabled }}</td>
            <td style="padding: 8px;">{{ prospect.hq_country or '-' }}</td>
            <td style="padding: 8px;">{{ ownership or '-' }}</td>
            <td style="padding: 8px;">{{ industry or '-' }}</td>
            <td style="padding: 8px;">{{ prospect.why_included|length }}</td>
            <td style="padding: 8px;">
                {% if prospect.why_included %}
                <details>
                    <summary style="cursor: pointer; color: #007bff;">Why included</summary>
                    <ul style="margin: 6px 0 0 16px; padding: 0;">
                        {% for sig in prospect.why_included %}
                        <li style="margin-bottom: 4px;">
                            <strong>{{ sig.field_key }}</strong> = {{ sig.value_normalized or sig.value }}
                            <span style="color: #555;">(conf {{ '%.2f'|format(sig.confidence) }})</span>
                            <span style="color: #888;">src {{ sig.source_document_id }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </details>
                {% else %}
                <span style="color: #777;">No signals</span>
                {% endif %}
            </td>
            <td style="padding: 8px;">
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    {% for target,status_label in [('accepted','Accept'),('hold','Hold'),('rejected','Reject')] %}
                    <form method="post" action="/ui/company-research/prospects/{{ prospect.id }}/review-status" style="margin: 0;">
                        <input type="hidden" name="run_id" value="{{ run.id }}">
                        <input type="hidden" name="review_status" value="{{ target }}">
                        <input type="hidden" name="redirect_query" value="{{ request.query_params|urlencode }}">
                        <button type="submit" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">{{ status_label }}</button>
                    </form>
                    {% endfor %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div style="padding: 12px; border: 1px solid #eee; background: #fafafa;">No ranked prospects found.</div>
{% endif %}
{% endblock %}
